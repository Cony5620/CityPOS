@model SaleWithDetailViewModel

@{
    ViewData["Title"] = "Sale";
}

<h3>Add Sale Record</h3><br />

@if (ViewData["Info"] != null)
{
    if (Convert.ToBoolean(ViewData["status"]))
    {
        <div class="alert alert-success" role="alert">
            @ViewData["Info"]
        </div>
    }
    else
    {
        <div class="alert alert-danger" role="alert">
            @ViewData["Info"]
        </div>
    }
}

<form asp-action="Entry" asp-controller="Sale" method="post">
<div class="container mt-3">
    <div class="row align-items-center">
        <!-- Sale Date -->
        <div class="col-3">
                <label asp-for="SaleOrder.SaleDate" class="form-label">Sale Date</label>
                <input type="date" id="saleDate" asp-for="SaleOrder.SaleDate" class="form-control" required>
        </div>

        <!-- VO No -->
        <div class="col-3">
                <label asp-for="SaleOrder.VoucherNo" class="form-label">Voucher No</label>
                <input type="text" asp-for="SaleOrder.VoucherNo" id="voNo" class="form-control" placeholder="VONO202412001" required>
        </div>
        <div class="col-2">
                <label asp-for="SaleOrder.Customerid" class="form-label">Customer</label>
                <select asp-for="SaleOrder.Customerid" class="form-select" required>
                <option value="">Select a Customer</option>
                @foreach (var customer in ViewBag.Customer)
                {
                    <option value="@customer.id">@customer.Name</option> 
                }
            </select>
        </div>

        <!-- RetailSale and WholeSale -->
        <div class="col-4 d-flex align-items-center">
            <div class="form-check me-3">
                <input type="radio" id="retail" name="saleType" value="Retail" class="form-check-input" checked>
                <label for="retail" class="form-check-label">RetailSale</label>
            </div>
            <div class="form-check me-3">
                <input type="radio" id="wholesale" name="saleType" value="Wholesale" class="form-check-input">
                <label for="wholesale" class="form-check-label">WholeSale</label>
            </div>

            <!-- Stock Switch -->
            <div class="form-check form-switch">
                <input type="checkbox" id="stockSwitch" class="form-check-input">
                <label for="stockSwitch" class="form-check-label">Stock On/Off</label>
            </div>
        </div>
    </div>
</div>

<div class="container mt-3">
    <div class="row align-items-center">
        <!-- Barcode -->
        <div class="col-2">
                <label for="barcode" class="form-label">Barcode</label>
            <input type="text" id="barcode" class="form-control" placeholder="Scan or Enter Barcode">
        </div>

        <!-- Item Dropdown -->
        
            <div class="col-2">
                <label  class="form-label" for="itemId">Item</label>
            <select id="itemId" name="Itemid" class="form-select" required>
                <option value="">Select an Item</option>
                @foreach (var item in ViewBag.Item)
                {
                    <option value="@item.Name">@item.Name</option>
                }
                </select>
            </div>


        <!-- Unit Dropdown -->
            <div class="col-1">
                <label class="form-label" for="unitId">Unit</label>
                <select id="unitId" name="Unitid" class="form-select" required>
                    <option value="">Select a Unit</option>
                    @foreach (var unit in ViewBag.Unit)
                    {
                        <option value="@unit.id">@unit.Name</option> <!-- Use unit.id for value and unit.Name for text -->
                    }
                </select>
            </div>



        <!-- Price -->
        <div class="col-1">
            <label for="price" class="form-label">Price</label>
            <input type="text" id="price" class="form-control" placeholder="0.00">
        </div>

        <!-- Quantity -->
        <div class="col-1">
            <label for="quantity" class="form-label">Qty</label>
            <input type="number" id="quantity" class="form-control" placeholder="0" min="1">
        </div>

        <!-- Discount (%) -->
        <div class="col-1">
            <label for="discountPercent" class="form-label">Disc %</label>
            <input type="number" id="discountPercent" class="form-control" placeholder="0" min="0" max="100">
        </div>

        <!-- Discount Amount -->
      @*   <div class="col-1">
            <label for="discountAmount" class="form-label">Disc Amt</label>
            <input type="text" id="discountAmount" class="form-control" placeholder="0.00">
        </div> *@

        <!-- FOC Checkbox -->
        <div class="col-1 d-flex align-items-center">
            <label class="form-check-label me-2" for="focCheckbox">FOC</label>
            <input type="checkbox" id="focCheckbox" class="form-check-input">
        </div>
        <!-- Add Button -->
        <div class="col-1">
            <button type="button" id="addButton" class="btn btn-primary mt-4">Add</button>
        </div>
       
    </div>
  
</div>
<div class="container mt-3">
   <table class="table " id="itemListTable" style="display: none;">
    <thead>
        <tr>
            <th>Item</th>
            <th>Unit</th>
            <th>Price</th>
            <th>Qty</th>
            <th>Disc %</th>
            <th>Disc Amt</th>
            <th>Amount</th>
            <th>FOC</th>
            <th>Total</th> 
            <th>Action</th>
        </tr>
    </thead>
    <tbody>
        <!-- Dynamic rows will be added here -->
    </tbody>
</table>
</div>



<div class="container mt-3 d-flex justify-content-end ">
    <div class="form-container ">
      

        <div class="row mb-1">
            <div class="col-4 d-flex">
                    <label asp-for="SaleOrder.SubTotal" for="SubTotal" class="form-label me-2">Sub Total:</label>
            </div>
            <div class="col-8 d-flex">
                    <input type="text" asp-for="SaleOrder.SubTotal" id="subTotal" class="form-control" readonly>
            </div>
        </div>
        <div class="row mb-1">
            <div class="col-4 d-flex">
                    <label asp-for="SaleOrder.TaxPercent" class="form-label me-2">Tax:</label>
            </div>
            <div class="col-4 d-flex">
                    <input type="number" asp-for="SaleOrder.TaxPercent"  id="taxPercent" class="form-control" placeholder="%">
            </div>
            <div class="col-4 d-flex">
                    <input type="number" asp-for="SaleOrder.Tax" id="taxAmount"  class="form-control" placeholder="0.00">
            </div>
        </div>

        <div class="row mb-1">
            <!-- Deliver Fee -->
            <div class="col-4 d-flex">
                    <label asp-for="SaleOrder.DeliverFees"  class="form-label me-2">Deliver Fee:</label>
            </div>
            <div class="col-8 d-flex">
                    <input type="number" asp-for="SaleOrder.DeliverFees"  id="deliveryFee" class="form-control" placeholder="0.00">
            </div>

        </div>
        <div class="row mb-1">
            <!-- Grand Total -->

            <div class="col-4 d-flex">
                    <label asp-for="SaleOrder.TotalAmount" class="form-label me-2">Grand Total:</label>
            </div>
            <div class="col-8 d-flex">
                    <input type="text" asp-for="SaleOrder.TotalAmount" id="grandTotal" class="form-control" placeholder="0.00" readonly>
            </div>

        </div>
        <div class="row mb-1">
            <!-- Discount -->

            <div class="col-4 d-flex">
                    <label asp-for="SaleOrder.DisPercent">Discount (%):</label>
            </div>
            <div class="col-4 d-flex">
                    <input type="number" asp-for="SaleOrder.DisPercent" id="overallDiscountPercent" class="form-control" placeholder="%" min="0" max="100">
            </div>
                <div class="col-4 d-flex">
                    <input type="number" asp-for="SaleOrder.DisAmount" id="overallDiscountAmount" class="form-control" placeholder="0.00" >
                </div>

        </div>
        <div class="row mb-1">
            <!-- Net Total -->
            <div class="col-4 d-flex">
                    <label  asp-for="SaleOrder.NetTotal" class="form-label me-2">Net Total:</label>

            </div>
            <div class="col-8 d-flex">

                    <input type="number" asp-for="SaleOrder.NetTotal"  id="netTotal" class="form-control" readonly>
            </div>
        </div>
        <div class="row mb-1">
            <!-- Cash Amount -->
            <div class="col-4 d-flex">
                    <label  asp-for="SaleOrder.CashAmount" class="form-label me-2">Cash Amount:</label>

            </div>
            <div class="col-8 d-flex">

                    <input type="text" asp-for="SaleOrder.CashAmount"  id="cashAmount" class="form-control" placeholder="0.00">
            </div>
        </div>
        <div class="row mb-1">
            <!-- Balance -->
            <div class="col-4 d-flex">
                    <label  asp-for="SaleOrder.Balance" class="form-label me-2">Balance:</label>

            </div>
            <div class="col-8 d-flex">

                    <input type="text" asp-for="SaleOrder.Balance" id="balance" class="form-control" placeholder="0.00" readonly>
            </div>
        </div>
            <!-- totalReturnAmount -->
         <div class="row mb-1">
            <div class="col-4 d-flex">
                    <label asp-for="SaleOrder.TotalReturnAmount" class="form-label me-2">TotalReturnAmount:</label>

            </div>
            <div class="col-8 d-flex">

                    <input type="text" asp-for="SaleOrder.TotalReturnAmount" id="totalReturnAmount" class="form-control" placeholder="0.00" readonly>
            </div>
        </div>
        <!-- Save and Refresh Buttons -->
        <div class="row mt-3">
            <div class="col-6 d-flex justify-content-end">
                    <button type="submit" class="btn btn-success me-2">Entry</button>
                <button type="button" id="refreshButton" class="btn btn-warning">Refresh</button>
            </div>
        </div>

</div>
</form>
 <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
    $(document).ready(function () {
        $('#barcode').on('input', function () {
            var barcode = $(this).val().trim();
            if (barcode) {
                $.ajax({
                    url: '@Url.Action("GetItemDetails", "Sale")',
                    type: 'GET',
                    data: { barcode: barcode },
                    success: function (data) {
                        if (data) {
                            console.log('Data received:', data);

                            // Populate the item dropdown
                            if (data.itemName) {
                                $('#itemId').val(data.itemName).change();
                            }

                            // Match the dropdown value to the unitName
                            if (data.unitName) {
                                console.log('Unit Name from server:', data.unitName);

                                // Find the option where the text matches unitName
                                const matchedOption = $('#unitId option').filter(function () {
                                    return $(this).text().trim().toLowerCase() === data.unitName.trim().toLowerCase();
                                });

                                if (matchedOption.length > 0) {
                                    matchedOption.prop('selected', true).change();
                                    console.log('Successfully matched and selected unit with ID:', matchedOption.val());
                                } else {
                                    console.error('Failed to match unitName:', data.unitName);
                                }
                            }


                            // Populate the price field based on the selected sale type
                            var saleType = $('input[name="saleType"]:checked').val();
                            if (saleType === 'Retail') {
                                $('#price').val(data.retailSalePrice || 0.00);
                                console.log('Price updated for Retail:', data.retailSalePrice);
                            } else if (saleType === 'Wholesale') {
                                $('#price').val(data.wholeSalePrice || 0.00);
                                console.log('Price updated for Wholesale:', data.wholeSalePrice);
                            }
                        } else {
                            console.error('No data found for the barcode');
                            $('#itemId, #unitId, #price').val('');
                        }
                    },
                    error: function () {
                        console.error('Error fetching item details');
                    }
                });
            } else {
                console.error('Barcode is empty');
            }
        });
    
            // Add button click event
            $('#addButton').on('click', function () {
                var itemName = $('#itemId').val();
                 var unitId = $('#unitId').val(); // Keep unitId for any backend logic if needed
                 var unitName = $('#unitId option:selected').text(); // Get the displayed text (unitName)
                var price = parseFloat($('#price').val()) || 0;
                var quantity = parseInt($('#quantity').val()) || 0;
                var discountPercent = parseFloat($('#discountPercent').val()) || 0;
                var isFoc = $('#focCheckbox').is(':checked');

                if (!itemName || !unitName || price <= 0 || quantity <= 0) {
                    alert("Please fill all required fields."); // Display error message
                    return false; // Prevent further execution
                }

                // Calculate Amount (Price * Quantity)
                var amount = (price * quantity).toFixed(2);
                amount = parseFloat(amount); // Convert back to number for calculations

                // Calculate Discount Amount
                var discountAmount = (amount * discountPercent / 100).toFixed(2);
                discountAmount = parseFloat(discountAmount); // Convert back to number for calculations

                // Calculate Total (Amount - Discount Amount)
                var total = amount - discountAmount;

                // If FOC is checked, set total to 0
                if (isFoc) {
                    total = 0;
                }

                // Append a new row to the table
                var newRow = `
                        <tr>
                            <td>${itemName}</td>
                            <td>${unitName}</td>
                            <td>${price.toFixed(2)}</td>
                            <td>${quantity}</td>
                            <td>${discountPercent.toFixed(2)}</td>
                            <td>${discountAmount.toFixed(2)}</td>
                            <td>${amount.toFixed(2)}</td>
                            <td>${isFoc ? 'Yes' : 'No'}</td>
                            <td>${total.toFixed(2)}</td> <!-- Total displayed based on FOC -->
                            <td>
                                <button type="button" class="btn btn-danger btn-sm delete-row">Delete</button>
                            </td>
                        </tr>
                    `;

                $('#itemListTable tbody').append(newRow);
                calculateTotals();
                // Show the table if it's hidden
                $('#itemListTable').show();
            });

            // Delete row functionality with confirmation
            $('#itemListTable').on('click', '.delete-row', function () {
                var confirmation = confirm("Are you sure you want to delete this item?");
                if (confirmation) {
                    $(this).closest('tr').remove();
                    calculateTotals();
                }
            });

            // Function to calculate totals
            function calculateTotals() {
                let subTotal = 0;
                $("#itemListTable tbody tr").each(function () {
                    const total = parseFloat($(this).find("td:nth-child(9)").text()) || 0;
                    subTotal += total;
                });

                $("#subTotal").val(subTotal.toFixed(2));
                let taxAmount = 0;
                let overallDiscountAmount = 0;

            const taxPercent = parseFloat($("#taxPercent").val()) || 0;
            if (taxPercent > 0) {
                taxAmount = (subTotal * taxPercent) / 100;
            } else {
                taxAmount = parseFloat($("#taxAmount").val()) || 0;
            }
            $("#taxAmount").val(taxAmount.toFixed(2));

                const deliveryFee = parseFloat($("#deliveryFee").val()) || 0;
                const grandTotal = subTotal + taxAmount + deliveryFee;
                $("#grandTotal").val(grandTotal.toFixed(2));

            const overallDiscountPercent = parseFloat($("#overallDiscountPercent").val()) || 0;
            if (overallDiscountPercent > 0) {
                overallDiscountAmount = (grandTotal * overallDiscountPercent) / 100;
            } else {
                overallDiscountAmount = parseFloat($("#overallDiscountAmount").val()) || 0;
            }
            $("#overallDiscountAmount").val(overallDiscountAmount.toFixed(2));
            const netTotal = grandTotal - overallDiscountAmount;
            $("#netTotal").val(netTotal.toFixed(2));

              
                const cashAmount = parseFloat($("#cashAmount").val()) || 0;

                     let balance = netTotal - cashAmount;
               
                let totalReturnAmount = 0;
                if (cashAmount > netTotal) {
                  
                    totalReturnAmount = cashAmount - netTotal;
                    balance = 0;

                } else if (cashAmount === netTotal) {
                
                    totalReturnAmount = 0;
                    balance = 0;
                } else {
                 
                    totalReturnAmount = 0;
                }

                 $("#balance").val(balance.toFixed(2));
                $("#totalReturnAmount").val(totalReturnAmount.toFixed(2));


            }

        // Add event listeners for changes to tax, delivery fee, and cash amount fields
        $("#taxPercent, #deliveryFee, #cashAmount, #overallDiscountPercent, #taxAmount, #overallDiscountAmount").on('input', function () {
            calculateTotals();
        });

            // Refresh button functionality
            $('#refreshButton').on('click', function () {
                // Display confirmation dialog
                if (confirm("Are you sure you want to refresh? Unsaved changes will be lost.")) {
                    // Option 1: Reload the page
                    location.reload();
                }
            });
       
         });
    </script>

   







